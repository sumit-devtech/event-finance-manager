// Prisma Schema for Event Budget Planning System

// ----------------------------------------------

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-simplifi"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_SIMPLIFI")
}

model Organization {
  id            String         @id @default(uuid())
  name          String
  industry      String?
  logoUrl       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  users         User[]
  subscriptions Subscription[]
  vendors       Vendor[]
  events        Event[]
}

model User {
  id                  String                @id @default(uuid())
  organizationId      String?
  fullName            String
  email               String                @unique
  role                String // admin / manager / viewer
  passwordHash        String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  organization        Organization?         @relation(fields: [organizationId], references: [id])
  createdEvents       Event[]               @relation("EventCreator")
  subscriptionHistory SubscriptionHistory[]
  expenses            Expense[]             @relation("ExpenseCreator")
  workflowActions     ApprovalWorkflow[]    @relation("ApproverWorkflow")
  activityLogs        ActivityLog[]
  notifications       Notification[]
  budgetVersions      BudgetVersion[]
  reports             Report[]
}

model Subscription {
  id                 String                @id @default(uuid())
  organizationId     String?
  planName           String
  billingCycle       String // monthly, yearly
  status             String // active, cancelled, expired
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  organization       Organization?         @relation(fields: [organizationId], references: [id])
  history            SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String       @id @default(uuid())
  subscriptionId String
  action         String // upgrade, downgrade, renew, cancel
  oldValue       Json?
  newValue       Json?
  changedBy      String?
  changedAt      DateTime     @default(now())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  user           User?        @relation(fields: [changedBy], references: [id])
}

model Event {
  id              String             @id @default(uuid())
  organizationId  String?
  name            String
  location        String?
  startDate       DateTime?
  endDate         DateTime?
  eventType       String?
  description     String?
  status          String             @default("draft")
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  organization    Organization?      @relation(fields: [organizationId], references: [id])
  creator         User?              @relation("EventCreator", fields: [createdBy], references: [id])
  stakeholders    EventStakeholder[]
  budgetVersions  BudgetVersion[]
  expenses        Expense[]
  vendorContracts VendorContract[]
  vendorEvents    VendorEvent[]
  insights        Insight[]
  roiMetrics      ROIMetrics?
  crmSync         CRMSync?
  reports         Report[]
  activityLogs    ActivityLog[]
}

model EventStakeholder {
  id        String   @id @default(uuid())
  eventId   String
  name      String
  role      String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
}

model BudgetVersion {
  id            String           @id @default(uuid())
  eventId       String
  versionNumber Int
  createdBy     String?
  notes         String?
  isFinal       Boolean          @default(false)
  createdAt     DateTime         @default(now())
  event         Event            @relation(fields: [eventId], references: [id])
  creator       User?            @relation(fields: [createdBy], references: [id])
  items         BudgetLineItem[]
}

model BudgetLineItem {
  id              String        @id @default(uuid())
  budgetVersionId String
  category        String
  itemName        String
  vendorId        String?
  quantity        Float?
  unitCost        Float?
  estimatedCost   Float?
  actualCost      Float?
  notes           String?
  createdAt       DateTime      @default(now())
  budgetVersion   BudgetVersion @relation(fields: [budgetVersionId], references: [id])
  vendor          Vendor?       @relation(fields: [vendorId], references: [id])
}

model Expense {
  id          String             @id @default(uuid())
  eventId     String
  vendorId    String?
  title       String
  amount      Float
  description String?
  status      String             @default("pending")
  createdBy   String?
  createdAt   DateTime           @default(now())
  event       Event              @relation(fields: [eventId], references: [id])
  vendor      Vendor?            @relation(fields: [vendorId], references: [id])
  creator     User?              @relation("ExpenseCreator", fields: [createdBy], references: [id])
  workflows   ApprovalWorkflow[]
}

model ApprovalWorkflow {
  id         String   @id @default(uuid())
  expenseId  String
  approverId String?
  action     String // approved / rejected
  comments   String?
  actionAt   DateTime @default(now())
  expense    Expense  @relation(fields: [expenseId], references: [id])
  approver   User?    @relation("ApproverWorkflow", fields: [approverId], references: [id])
}

model Vendor {
  id             String           @id @default(uuid())
  organizationId String?
  name           String
  serviceType    String?
  contactPerson  String?
  email          String?
  phone          String?
  gstNumber      String?
  rating         Float?
  createdAt      DateTime         @default(now())
  organization   Organization?    @relation(fields: [organizationId], references: [id])
  vendorEvents   VendorEvent[]
  contracts      VendorContract[]
  budgetItems    BudgetLineItem[]
  expenses       Expense[]
}

model VendorEvent {
  id         String   @id @default(uuid())
  vendorId   String
  eventId    String
  assignedAt DateTime @default(now())
  vendor     Vendor   @relation(fields: [vendorId], references: [id])
  event      Event    @relation(fields: [eventId], references: [id])
}

model VendorContract {
  id              String    @id @default(uuid())
  vendorId        String
  eventId         String
  contractFileUrl String?
  amount          Float?
  startDate       DateTime?
  endDate         DateTime?
  terms           String?
  createdAt       DateTime  @default(now())
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  event           Event     @relation(fields: [eventId], references: [id])
}

model Insight {
  id          String   @id @default(uuid())
  eventId     String
  insightType String?
  data        Json?
  createdAt   DateTime @default(now())
  event       Event    @relation(fields: [eventId], references: [id])
}

model ROIMetrics {
  id               String   @id @default(uuid())
  eventId          String   @unique
  totalBudget      Float?
  actualSpend      Float?
  leadsGenerated   Int?
  conversions      Int?
  revenueGenerated Float?
  roiPercent       Float?
  createdAt        DateTime @default(now())
  event            Event    @relation(fields: [eventId], references: [id])
}

model CRMSync {
  id           String    @id @default(uuid())
  eventId      String    @unique
  crmSystem    String?
  syncStatus   String?
  lastSyncedAt DateTime?
  data         Json?
  event        Event     @relation(fields: [eventId], references: [id])
}

model Report {
  id         String   @id @default(uuid())
  eventId    String
  reportType String?
  createdBy  String?
  createdAt  DateTime @default(now())
  event      Event    @relation(fields: [eventId], references: [id])
  creator    User?    @relation(fields: [createdBy], references: [id])
  files      File[]
}

model File {
  id        String   @id @default(uuid())
  reportId  String
  fileUrl   String
  fileType  String?
  createdAt DateTime @default(now())
  report    Report   @relation(fields: [reportId], references: [id])
}

model ActivityLog {
  id        String   @id @default(uuid())
  eventId   String
  userId    String?
  action    String
  details   Json?
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String?
  message   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}
